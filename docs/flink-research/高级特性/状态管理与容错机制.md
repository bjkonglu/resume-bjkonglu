## çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶

### çŠ¶æ€ç®¡ç†çš„åŸºæœ¬æ¦‚å¿µ

#### ä»€ä¹ˆæ˜¯çŠ¶æ€
ä¸ºäº†è¯´æ˜ä»€ä¹ˆæ˜¯çŠ¶æ€ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸¤ä¸ªä¾‹å­ï¼Œç¬¬ä¸€ä¸ªä¾‹å­å°±æ˜¯æ— çŠ¶æ€è®¡ç®—çš„ä¾‹å­ï¼ˆæ¶ˆè´¹å»¶æ—¶è®¡ç®—ï¼‰ã€‚åœ¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—é‡Œï¼Œä¸€ä¸ªç”Ÿäº§è€…æŒç»­å†™å…¥æ•°æ®ï¼ŒåŒæ—¶å¤šä¸ªæ¶ˆè´¹ç»„åˆ†åˆ«æ¶ˆè´¹æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç„¶åè®©æˆ‘ä»¬å®ç°å®æ—¶ç»Ÿè®¡æ¯ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ç§¯å‹å€¼éœ€æ±‚ã€‚

![æ— çŠ¶æ€è®¡ç®—ä¾‹å­](../../pics/flink/stateless_exmaple.png)

é’ˆå¯¹è¿™æ ·çš„éœ€æ±‚ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ä¸€ä¸ªæ“ä½œç®—å­é‡Œå¯¹æ¯æ¡æ•°æ®æ‰§è¡Œå‡æ³•æ“ä½œï¼Œä¾‹å¦‚*consumer0 - producer*å°±å¯ä»¥å¾—åˆ°consumer0çš„æ¶ˆè´¹ç§¯å‹å€¼ï¼Œä¸éœ€è¦ä¾èµ–å…¶ä»–ã€‚è¿™æ ·å°±æ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„è®¡ç®—ã€‚
```
è¾“å…¥æ•°æ®ï¼š
{
    "timestamp": 1555516800,
    "offset":
    {
        "producer": 15,
        "consumer0": 10,
        "consumer1": 7,
        "consumer2": 12
} }

è¾“å‡ºæ•°æ®ï¼š
{
    "timestamp": 1555516800,
    "lag":
    {
        "consumer0": 5,
        "consumer1": 8,
        "consumer2": 3
} }
```

ä¸‹é¢æˆ‘ä»¬å†çœ‹çœ‹æœ‰çŠ¶æ€è®¡ç®—çš„ä¾‹å­ï¼ˆè®¿é—®é‡ç»Ÿè®¡ï¼‰ï¼Œé€šè¿‡nginxè®¿é—®æ—¥å¿—ï¼ˆæ¯ä¸ªè¯·æ±‚è®¿é—®ä¸€ä¸ªURLåœ°å€ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå®æ—¶è®¡ç®—ç»Ÿè®¡æ¯ä¸ªåœ°å€æ€»å…±è¢«è®¿é—®æ¬¡æ•°çš„éœ€æ±‚ã€‚

![æœ‰çŠ¶æ€è®¡ç®—ä¾‹å­](../../pics/flink/state_example.png)

å½“æˆ‘ä»¬å®ç°è¿™ä¸ªéœ€æ±‚æ—¶ï¼Œé€šè¿‡ç®—å­å»å¤„ç†å•æ¡æ•°æ®ï¼Œä¸èƒ½å¾—åˆ°å®Œæ•´çš„è®¡ç®—ç»“æœï¼Œä¾èµ–ä¹‹å‰è®¡ç®—çš„ç»“æœï¼Œè€Œè¿™ä¸ªä¹‹å‰çš„è®¡ç®—ç»“æœå°±æ˜¯æˆ‘ä»¬è¯´çš„*çŠ¶æ€*ã€‚
```
è¾“å…¥æ•°æ®ï¼š
[{
    "@timestamp": "18/Apr/2019:00:00:00",
    "remote_addr": "127.0.0.1",
    "request": "GET",
    "url": "/api/a"
}, {
    "@timestamp": "18/Apr/2019:00:00:01",
    "remote_addr": "127.0.0.1",
    "request": "POST",
    "url": "/api/b"
}, {
    "@timestamp": "18/Apr/2019:00:00:00",
    "remote_addr": "127.0.0.1",
    "request": "GET",
    "url": "/api/a"
}]

è¾“å‡ºæ•°æ®ï¼š
[{
    "url": "/api/a",
    "count": 1
}, {
    "url": "/api/b",
    "count": 1
}, {
    "url": "/api/a",
    "count": 2 }]
```

çŸ¥é“äº†ä»€ä¹ˆæ˜¯çŠ¶æ€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¹³æ—¶éƒ½åœ¨ä»€ä¹ˆæ—¶å€™å»ä½¿ç”¨çŠ¶æ€å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬ç½—åˆ—ä¸€ä¸‹ä½¿ç”¨çŠ¶æ€çš„åœºæ™¯ï¼š
- å»é‡ï¼šé€šè¿‡çŠ¶æ€è®°å½•æ‰€æœ‰çš„ä¸»é”®å®ç°
- çª—å£è®¡ç®—ï¼š å·²è¿›å…¥çš„æœªè§¦å‘çš„æ•°æ®
- æœºå™¨å­¦ä¹ /æ·±åº¦å­¦ä¹ ï¼š è®­ç»ƒçš„æ¨¡å‹åŠå‚æ•°
- è®¿é—®å†å²æ•°æ®ï¼šéœ€è¦ä¸å†å²è¿›è¡Œå¯¹æ¯”

### çŠ¶æ€çš„ç±»å‹ä¸ä½¿ç”¨ç¤ºä¾‹

#### Keyed State and Operator State

| Keyed State| Operator State|
|:-----------|:--------------|
|åªèƒ½ç”¨åœ¨KeyedStreamä¸Šçš„ç®—å­ä¸­|å¯ä»¥ç”¨äºæ‰€æœ‰ç®—å­|
|æ¯ä¸ªKeyå¯¹åº”ä¸€ä¸ªStateï¼Œæ¯ä¸ªOperatorå®ä¾‹å¤„ç†å¤šä¸ªKeyï¼Œè®¿é—®ç›¸åº”çš„å¤šä¸ªState|ä¸€ä¸ªOperatorå®ä¾‹å¯¹åº”ä¸€ä¸ªState|
|å¹¶å‘æ”¹å˜ï¼ŒStateéšç€Keyåœ¨å®ä¾‹é—´è¿ç§»|å¹¶å‘æ”¹å˜æ—¶æœ‰å¤šç§é‡æ–°åˆ†é…æ–¹å¼å¯é€‰ï¼š1ï¼‰å‡åŒ€åˆ†é…ï¼›2ï¼‰åˆå¹¶åæ¯ä¸ªå¾—åˆ°å…¨é‡|
|é€šè¿‡RuntimeContextè®¿é—®ï¼Œè€ŒRichFunctionå­ç±»å¯ä»¥è·å–RuntimeContext | å®ç°CheckpointedFunctionæˆ–è€…ListCheckpointedæ¥å£|
|æ”¯æŒçš„æ•°æ®ç»“æ„ï¼š1ï¼‰ValueStateï¼›2ï¼‰ListStateï¼›3ï¼‰ReducingStateï¼›4ï¼‰AggregatingStateï¼›5ï¼‰MapStateï¼›| æ”¯æŒçš„æ•°æ®ç»“æ„ï¼šListState |


#### Keyed Stateä¹‹é—´çš„å…³ç³»å’Œå·®å¼‚

ç”±äºæˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°Keyed Stateæ¯”è¾ƒå¤šï¼Œæ‰€ä»¥å…ˆä»‹ç»ä¸€ä¸‹å‡ ç§Keyed Stateä¹‹é—´çš„å…³ç³»ï¼š

![keyed_state_relationship](../../pics/flink/keyed_state_relationship.png)

ç„¶åæˆ‘ä»¬å†çœ‹å‡ ç§Keyed Stateä¹‹é—´çš„å·®å¼‚ï¼š

![keyed_state_diff](../../pics/flink/keyed_state_diff.png)

#### ä¸¾ä¸ªğŸŒ°

æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œæ¥å®æˆ˜ä¸€ä¸‹æ€ä¹ˆä½¿ç”¨çŠ¶æ€ã€‚æˆ‘ä»¬é€šè¿‡ç»§æ‰¿RichFunctionå¯ä»¥è·å–çŠ¶æ€ï¼Œå…·ä½“åœ¨open(..)æ–¹æ³•ä¸­ï¼Œé€šè¿‡getRuntimeContext.getState(..)æ¥è·å–çŠ¶æ€å¯¹è±¡ï¼Œç„¶ååœ¨æˆ‘ä»¬å¤„ç†æ•°æ®çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ä¸Šè·å–åˆ°çš„çŠ¶æ€æ•°æ®äº†ï¼Œå…·ä½“çš„å®ç°å¦‚ä¸‹ä»£ç 

```java
static class StateMachineMapper extends RichFlatMapFunction<Event, Alert> {

		/** The state for the current key. */
		private ValueState<State> currentState;

		@Override
		public void open(Configuration conf) {
			// get access to the state object
			currentState = getRuntimeContext().getState(
						new ValueStateDescriptor<>("state", State.class));
		}

		@Override
		public void flatMap(Event evt, Collector<Alert> out) throws Exception {
			// get the current state for the key (source address)
			// if no state exists, yet, the state must be the state machine's initial state
			State state = currentState.value();
			if (state == null) {
				state = State.Initial;
			}

			// ask the state machine what state we should go to based on the given event
			State nextState = state.transition(evt.type());

			if (nextState == State.InvalidTransition) {
				// the current event resulted in an invalid transition
				// raise an alert!
				out.collect(new Alert(evt.sourceAddress(), state, evt.type()));
			}
			else if (nextState.isTerminal()) {
				// we reached a terminal state, clean up the current state
				currentState.clear();
			}
			else {
				// remember the new state
				currentState.update(nextState);
			}
		}
	}
```

### å®¹é”™æœºåˆ¶ä¸æ•…éšœæ¢å¤

#### çŠ¶æ€ä¿å­˜ä¸æ¢å¤
åœ¨Flinké‡Œä½¿ç”¨Checkpointï¼ˆåˆ†å¸ƒå¼å¿«ç…§ï¼‰æ¥å¯¹ç¨‹åºä¸­çš„çŠ¶æ€è¿›è¡Œå¤‡ä»½ï¼Œå½“è¿è¡Œä½œä¸šå‘ç”Ÿæ•…éšœæ—¶ï¼ŒFlinkå°†æ•´ä¸ªä½œä¸šçš„æ‰€æœ‰Taskéƒ½å›æ»šåˆ°æœ€åä¸€æ¬¡æˆåŠŸCheckpointçš„çŠ¶æ€ï¼Œç„¶åä»ä¸Šæ¬¡æˆåŠŸçš„chkå¼€å§‹ç»§ç»­å¤„ç†ã€‚æ³¨æ„ï¼Œè¦å®ç°ä¸Šè¿°æ•…éšœæ¢å¤çš„å¿…è¦æ¡ä»¶æ˜¯æ•°æ®æºæ”¯æŒæ•°æ®é‡å‘ï¼Œä¾‹å¦‚Apache Kafkaã€‚

ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨Flinkç¨‹åºé‡Œï¼Œå¦‚ä½•å¼€å¯chkå¹¶é…ç½®chkã€‚
```java

StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(); 
env.enableCheckpointing(1000);
env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE); 
env.getCheckpointConfig().setMinPauseBetweenCheckpoints(500); env.getCheckpointConfig().setCheckpointTimeout(60000);
env.getCheckpointConfig().setMaxConcurrentCheckpoints(1);
env.getCheckpointConfig().enableExternalizedCheckpoints(ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION);
 
```

æ­¤å¤–ï¼ŒFlinkè¿˜æä¾›äº†å¦ä¸€ç§ä¿å­˜çŠ¶æ€çš„æ–¹å¼ï¼Œå³Savepointã€‚ä¸‹é¢æˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹Checkpointä¸Savepointä¹‹é—´çš„å·®åˆ«ï¼š

|åŒºåˆ«é¡¹|Checkpoint|Savepoint|
|:--|:---------|:--------|
|è§¦å‘ç®¡ç†æ–¹å¼|ç”±Flinkè‡ªåŠ¨è§¦å‘å¹¶ç®¡ç†|ç”±ç”¨æˆ·æ‰‹åŠ¨è§¦å‘å¹¶ç®¡ç†|
|ä¸»è¦ç”¨é€”|åœ¨Taskå‘ç”Ÿå¼‚å¸¸æ—¶å¿«é€Ÿæ¢å¤ä½œä¸š|æœ‰è®¡åˆ’åœ°è¿›è¡Œå¤‡ä»½ï¼Œä½¿ä½œä¸šèƒ½åœæ­¢å†æ¢å¤ï¼Œä¾‹å¦‚ä¿®æ”¹ä»£ç ã€è°ƒæ•´å¹¶å‘åº¦|
|ç‰¹ç‚¹|1ï¼‰è½»é‡ï¼›2ï¼‰è‡ªåŠ¨ä»æ•…éšœä¸­æ¢å¤ï¼›3ï¼‰åœ¨ä½œä¸šåœæ­¢åé»˜è®¤æ¸…é™¤|1ï¼‰æŒä¹…ï¼›2ï¼‰ä»¥æ ‡å‡†æ ¼å¼å­˜å‚¨ï¼Œè¿è¡Œä»£ç æˆ–è€…é…ç½®å‘ç”Ÿæ”¹å˜ï¼›3ï¼‰æ‰‹åŠ¨è§¦å‘ä»Savepointä¸­æ¢å¤|


#### çŠ¶æ€åç«¯ç±»å‹

|åŒºåˆ«é¡¹|MemoryStateBackend|FsStateBackend|RocksDBStateBackend|
|:----|:-----------------|:-------------|:-------------------|
|æ„é€ æ–¹æ³•|MemoryStateBackend(int maxStateSize, boolean asynchronousSnapshots)|FsStateBackend(URI checkpointDataUri, boolean asynchronousSnapshots)|RocksDBStateBackend(URI checkpointDataUri, boolean enableIncrementalCheckpointing)|
|å­˜å‚¨æ–¹å¼|1ï¼‰State:TaskManagerå†…å­˜ï¼›2ï¼‰Checkpoint: JobManagerå†…å­˜|1ï¼‰State: TaskManagerå†…å­˜ï¼›2ï¼‰Checkpoint: å¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿï¼ˆæœ¬åœ°æˆ–è€…HDFSï¼‰|1ï¼‰State: TaskManagerä¸Šçš„KVæ•°æ®åº“ï¼ˆRocksDBï¼‰(å®é™…ä¸Šä½¿ç”¨å†…å­˜+ç£ç›˜)ï¼›2ï¼‰Checkpoint: å¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿï¼ˆæœ¬åœ°æˆ–è€…HDFSï¼‰|
|å®¹é‡é™åˆ¶|1ï¼‰å•ä¸ªState maxStateSizeé»˜è®¤5Mï¼›2ï¼‰maxStateSize <= akka.framesizeé»˜è®¤10Mï¼›3ï¼‰æ€»å¤§å°ä¸è¶…è¿‡JobManagerçš„å†…å­˜|1ï¼‰å•ä¸ªTaskManagerä¸ŠStateæ€»é‡ä¸è¶…è¿‡å®ƒçš„å†…å­˜ï¼›2ï¼‰æ€»å¤§å°ä¸è¶…è¿‡é…ç½®çš„æ–‡ä»¶ç³»ç»Ÿå®¹é‡|1ï¼‰å•ä¸ªTaskManagerä¸Šçš„Stateæ€»é‡ä¸è¶…è¿‡å®ƒçš„å†…å­˜+ç£ç›˜ï¼›2ï¼‰å•ä¸ªKeyæœ€å¤§2Gï¼›3ï¼‰æ€»å¤§å°ä¸è¶…è¿‡é…ç½®çš„æ–‡ä»¶ç³»ç»Ÿå®¹é‡|
|æ¨èä½¿ç”¨åœºæ™¯|1ï¼‰æœ¬åœ°æµ‹è¯•ï¼›2ï¼‰å‡ ä¹æ— çŠ¶æ€çš„ä½œä¸šï¼Œä¾‹å¦‚ETLä»»åŠ¡ï¼›3ï¼‰ä¸æ¨èåœ¨ç”Ÿäº§åœºæ™¯ä½¿ç”¨|1ï¼‰å¸¸è§„ä½¿ç”¨çŠ¶æ€çš„ä½œä¸šï¼Œä¾‹å¦‚åˆ†é’Ÿçº§åˆ«çš„çª—å£èšåˆã€joinï¼›2ï¼‰éœ€è¦å¼€å§‹HAçš„ä½œä¸šï¼›3ï¼‰å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨|1ï¼‰è¶…å¤§çŠ¶æ€ä½œä¸šï¼Œä¾‹å¦‚å¤©çº§åˆ«çš„çª—å£èšåˆï¼›2ï¼‰éœ€è¦å¼€å§‹HAçš„ä½œä¸šï¼›3ï¼‰å¯¹çŠ¶æ€è¯»å†™æ€§èƒ½è¦å†™ä¸é«˜çš„ä½œä¸šï¼›4ï¼‰å¯ä»¥åœ¨ç”Ÿäº§åœºæ™¯ä½¿ç”¨|
